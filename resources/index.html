<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Elm d3-map</title>
        <link rel="stylesheet" href="css/base.css" />

    </head>

    <body>
        <!-- We'll render everything inside this div. -->
        <div id="content">
            <div id="app"></div>
        </div>

        <!-- Import our compiled Elm code -->
        <script src="js/JsonClue.js"></script>
        <!-- <script src="https://d3js.org/d3.v4.min.js"></script>
             <script src="//d3js.org/topojson.v1.min.js"></script> -->
        <script src="js/d3.min.js"></script>
        <script src="js/topojson.min.js"></script>
        <!-- Run our Elm app! -->
        <script>
         function zoomed(g,mesh){
             return function(){
                 var transform = d3.event.transform
                 g.attr("transform",transform)

                 //var k = 30 > transform.k ? 30 : transform.k
                 //mesh.style("stroke-width",1/k)
                 //console.log(d3.event.transform.k)
                 return null
             }
         }
         var app =
             // Note: if your Elm module is named "MyThing.Root" you
             // would call "Elm.MyThing.Root.embed(node)" instead.
             Elm.JsonClue.embed(document.getElementById("app"),{
                 'mapfile':'data/CA_grid_topology4326.json',
                 'dataUrl':'data'})

         app.ports.getColorJson.subscribe(function(json) {
             var c = d3.scalePow().exponent(0.3)
                       .domain([0, 1744422])
                       .range([0,1])
             var colormap = {}
             // apply c.interpolateViridis to each incoming thing
             var cellids = Object.keys(json)
             var maxsum = 0
             cellids.forEach(function(cellid){
                 var roaddata = json[cellids]
                 var roadtypes = Object.keys(roaddata)

                 // sum up sum_vmt and n_mt values
                 var sum = roadtypes.reduce(function(prev,curr){
                     var val = 0
                     if(roaddata[curr].sum_vmt !== undefined){
                         val = +roaddata[curr].sum_vmt
                     }else{
                         if(roaddata[curr].n_mt !== undefined){
                             val = +roaddata[curr].n_mt
                         }}
                     return prev + val
                 })
                 maxsum = sum > maxsum ? sum : maxsum
                 colormap[cellid] = c.interpolateViridis(sum)
             })
             console.log(maxsum)
             app.ports.colors.send(colormap)

         })

         app.ports.getTopoJson.subscribe(function(json) {
             var allgrids = json.objects.grids
             // from http://bl.ocks.org/mbostock/5126418
             var land =
                 topojson.feature(json,{"type":"GeometryCollection"
                                       ,"geometries":allgrids.geometries})
             var mesh =
                 topojson.mesh(json, allgrids, function(a, b) { return a !== b; })

             var path = d3.geoPath()
                          .projection(d3.geoTransverseMercator()
                                        .rotate([124, -32.5])
                                        .fitExtent([[10,10],[480,480]],land))

             var id_path = land.features.map(function(f){
                 var p = f.properties
                 var id = (p.i_cell + "_" + p.j_cell)
                     .replace(/\.0*/g,"")

                 return {"id":id
                        ,"path":path(f)}
             })
             var svg, g, zoom, mesh

             // render the map outline here, handle the coloring in elm
             svg = d3.select("svg")
             var g = svg.select("g")

             /* g.selectAll("path")
              *    .data(land.features,function(d,i){
              *        return d.properties.id
              *    })
              *    .enter().append("path")
              *    .attr("class","grid")
              *    .attr("d",path)*/
             /* mesh = g.append("path")
              *     .datum(mesh)
              *     .attr("class","grid-border")
              *     .attr("d",path)
              */
             zoom = d3.zoom()
                          .scaleExtent( [1, 512])
                          .on("zoom", zoomed(g,mesh));

             svg.call(zoom)
             /* .select("rect")/*
              *                   .attr("class","overlay")
              *                   .attr("width",500)
              *                   .attr("height",500)
              *
              */

             app.ports.features.send(id_path)

             return null
             })
         function update(data){
             console.log(data)
             return null
         }

        </script>
    </body>

</html>
